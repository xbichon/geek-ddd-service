# 项目开发文档

## 目录
1. [架构设计](#1-架构设计)
2. [目录结构](#2-目录结构)
3. [开发规范](#3-开发规范)
4. [新建模块配置](#4-新建模块配置)

---

## 1. 架构设计

### 1.1 整体架构

本项目采用 **DDD（领域驱动设计）** 和 **CQRS（命令查询职责分离）** 架构模式，旨在构建高内聚、低耦合、易维护的企业级应用系统。

#### 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                    Adapter Layer (适配器层)                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   Web API   │ │   Security  │ │   Config    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  Application Layer (应用层)                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   Command   │ │    Query    │ │   Service   │            │
│  │  (写操作)    │ │  (读操作)    │ │  (协调)     │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer (领域层)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   Model     │ │  Repository │ │   Service   │            │
│  │ (聚合根)     │ │  (仓储)     │ │ (领域服务)   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                 Infrastructure Layer (基础设施层)              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  Database   │ │   Cache     │ │   Message   │            │
│  │  (数据库)    │ │  (缓存)     │ │  (消息)     │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 DDD 核心概念

#### 1.2.1 聚合根 (Aggregate Root)
- **定义**: 聚合的入口点，负责维护聚合内部的一致性边界
- **职责**: 
  - 维护聚合内部的一致性
  - 提供聚合的唯一标识符
  - 封装聚合内部的业务逻辑
- **实现**: 继承 `AggregateRoot<T>` 接口

```java
@Entity
@Table(name = "manager_department")
public class Department implements AggregateRoot<Long> {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    // 业务方法和验证逻辑
    public static Department createSubDepartment(String name, Department parent, ...) {
        // 业务逻辑实现
    }
}
```

#### 1.2.2 值对象 (Value Object)
- **定义**: 不可变的对象，通过属性值而非标识符来区分
- **特点**: 
  - 不可变
  - 包含业务验证逻辑
  - 无副作用
- **实现**: 使用 `@Embeddable` 注解

```java
@Embeddable
public class ContactInfo {
    private String phone;
    private String email;
    
    public ContactInfo(String phone, String email) {
        validatePhone(phone);
        validateEmail(email);
        this.phone = phone;
        this.email = email;
    }
    
    private void validatePhone(String phone) {
        // 手机号验证逻辑
    }
}
```

#### 1.2.3 领域服务 (Domain Service)
- **定义**: 处理跨聚合的业务逻辑或复杂的领域规则
- **使用场景**: 
  - 跨聚合的业务规则
  - 复杂的计算逻辑
  - 外部服务集成
- **实现**: 使用 `@Service` 注解

```java
@Service
public class DepartmentDomainService {
    public void validateDepartmentNameUnique(String name, Long parentId) {
        // 跨聚合的业务验证逻辑
    }
}
```

### 1.3 CQRS 模式

#### 1.3.1 命令 (Command)
- **定义**: 表示用户的写操作意图
- **特点**: 
  - 不可变
  - 包含验证注解
  - 对应具体的业务操作
- **实现**: 实现 `Command` 接口

```java
public class CreateDepartmentCommand implements Command {
    @NotBlank(message = "部门名称不能为空")
    @Size(max = 50, message = "部门名称不能超过50个字符")
    private String name;
    
    @NotNull(message = "父部门ID不能为空")
    private Long parentId;
    
    // getters and setters
}
```

#### 1.3.2 查询 (Query)
- **定义**: 专门用于数据查询和展示
- **特点**: 
  - 只读操作
  - 可以跨表查询
  - 支持缓存优化
- **实现**: 使用专门的查询服务

```java
@Service
public class DepartmentTreeQueryService {
    public List<DepartmentTreeResult> getDepartmentTree() {
        // 复杂的树形查询逻辑
    }
}
```

#### 1.3.3 命令处理器 (Command Handler)
- **定义**: 处理具体的命令，执行业务逻辑
- **特点**: 
  - 单一职责
  - 事务性
  - 返回操作结果
- **实现**: 实现 `CommandHandler<C, T>` 接口

```java
@Service
public class CreateDepartmentCommandHandler implements CommandHandler<CreateDepartmentCommand, Long> {
    @Override
    @Transactional
    public CommandResult<Long> handle(CreateDepartmentCommand command) {
        // 业务逻辑实现
        return CommandResult.ok("部门创建成功", department.getId());
    }
}
```

---

## 2. 目录结构

### 2.1 项目整体结构

```
service/
├── adapter/                    # 适配器层 - 对外接口和配置
│   ├── src/main/java/vip/geekclub/
│   │   ├── Application.java           # 应用启动类
│   │   ├── config/                    # 配置类
│   │   │   ├── SecurityConfig.java    # 安全配置
│   │   │   ├── WebConfig.java         # Web配置
│   │   │   └── AsyncConfig.java       # 异步配置
│   │   └── controller/                # 控制器层
│   │       ├── manager/               # 管理模块控制器
│   │       ├── system/                # 系统模块控制器
│   │       └── TestController.java    # 测试控制器
│   └── src/main/resources/
│       ├── application.yml            # 应用配置
│       ├── logback-spring.xml         # 日志配置
│       └── db/changelog/master.xml    # 数据库变更主文件
├── common/                     # 公共模块 - 基础设施和通用组件
│   ├── src/main/java/vip/geekclub/common/
│   │   ├── command/                   # 命令模式基础设施
│   │   │   ├── Command.java           # 命令接口
│   │   │   ├── CommandBus.java        # 命令总线
│   │   │   ├── CommandHandler.java    # 命令处理器接口
│   │   │   └── CommandResult.java     # 命令结果
│   │   ├── domain/                    # 领域基础设施
│   │   │   ├── AggregateRoot.java     # 聚合根接口
│   │   │   ├── DomainEvent.java       # 领域事件
│   │   │   └── AuditInfo.java         # 审计信息
│   │   ├── exception/                 # 异常定义
│   │   ├── controller/                # 控制器基础设施
│   │   └── utils/                     # 工具类
├── manager/                    # 管理模块 - 部门和菜单管理
│   ├── src/main/java/vip/geekclub/manager/
│   │   ├── command/                   # 命令处理
│   │   │   ├── department/            # 部门命令
│   │   │   └── menu/                  # 菜单命令
│   │   ├── query/                     # 查询服务
│   │   ├── domain/                    # 领域模型
│   │   │   ├── model/                 # 聚合根
│   │   │   ├── repository/            # 仓储接口
│   │   │   ├── service/               # 领域服务
│   │   │   └── values/                # 值对象
│   │   └── common/                    # 模块公共组件
│   └── src/main/resources/
│       ├── db/changelog/v1.0/         # 数据库变更文件
│       └── plugin/config/             # 插件配置
├── security/                   # 安全模块 - 用户和权限管理
├── student/                    # 学生模块 - 学生管理
└── pom.xml                     # 父POM文件
```

### 2.2 各层职责说明

#### 2.2.1 Adapter Layer (适配器层)
**位置**: `adapter/` 模块
**职责**:
- 对外提供 REST API 接口
- 处理 HTTP 请求和响应
- 安全认证和授权
- 配置管理
- 异常处理和日志记录

**代码组织**:
```java
// 控制器示例
@RestController
@RequestMapping("/api/departments")
public class DepartmentController {
    
    @PostMapping
    public ApiResponse<Long> createDepartment(@RequestBody @Valid CreateDepartmentCommand command) {
        return commandBus.dispatchForWeb(command);
    }
}
```

#### 2.2.2 Application Layer (应用层)
**位置**: 各业务模块的 `command/` 和 `query/` 包
**职责**:
- 协调领域对象完成业务操作
- 处理命令和查询
- 事务管理
- 应用服务编排

**代码组织**:
```java
// 命令处理器示例
@Service
public class CreateDepartmentCommandHandler implements CommandHandler<CreateDepartmentCommand, Long> {
    
    @Override
    @Transactional
    public CommandResult<Long> handle(CreateDepartmentCommand command) {
        // 业务逻辑实现
    }
}

// 查询服务示例
@Service
public class DepartmentTreeQueryService {
    
    public List<DepartmentTreeResult> getDepartmentTree() {
        // 查询逻辑实现
    }
}
```

#### 2.2.3 Domain Layer (领域层)
**位置**: 各业务模块的 `domain/` 包
**职责**:
- 定义业务实体和值对象
- 实现业务规则和逻辑
- 定义仓储接口
- 处理领域事件

**代码组织**:
```java
// 聚合根示例
@Entity
@Table(name = "manager_department")
public class Department implements AggregateRoot<Long> {
    
    // 业务方法
    public static Department createSubDepartment(String name, Department parent, ...) {
        // 业务逻辑
    }
    
    public void updateInfo(String name, ContactInfo contactInfo) {
        // 业务逻辑
    }
}

// 值对象示例
@Embeddable
public class ContactInfo {
    private String phone;
    private String email;
    
    // 验证逻辑
    private void validatePhone(String phone) {
        // 验证实现
    }
}
```

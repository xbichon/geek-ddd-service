# 新建模块配置指南

## 4. 新建模块配置

### 4.1 模块创建步骤

#### 4.1.1 创建模块目录结构
```
new-module/
├── pom.xml
└── src/
    ├── main/
    │   ├── java/vip/geekclub/newmodule/
    │   │   ├── command/
    │   │   │   ├── dto/
    │   │   │   └── handlers/
    │   │   ├── query/
    │   │   │   └── dto/
    │   │   ├── domain/
    │   │   │   ├── model/
    │   │   │   ├── repository/
    │   │   │   ├── service/
    │   │   │   └── values/
    │   │   └── common/
    │   └── resources/
    │       ├── db/
    │       │   └── changelog/
    │       │       └── v1.0/
    │       └── plugin/
    │           └── config/
    └── test/
        └── java/vip/geekclub/newmodule/
```

#### 4.1.2 创建模块POM文件
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>vip.geekclub</groupId>
        <artifactId>service</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>

    <artifactId>new-module</artifactId>

    <properties>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>vip.geekclub</groupId>
            <artifactId>common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.jooq</groupId>
            <artifactId>jooq</artifactId>
        </dependency>
    </dependencies>
</project>
```

### 4.2 Liquibase 配置

#### 4.2.1 创建 Liquibase 配置文件
**文件位置**: `src/main/resources/plugin/config/liquibase-config.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- 使用当前目录的相对路径 -->
    <includeAll path="db/changelog" minDepth="2" />
</databaseChangeLog>
```

#### 4.2.2 创建数据库变更文件
**文件位置**: `src/main/resources/db/changelog/v1.0/newmodule_table.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
    
    <!-- 创建表结构 -->
    <changeSet id="1750312342960-1" author="developer">
        <createTable tableName="newmodule_entity">
            <column name="id" type="BIGINT" autoIncrement="true" remarks="主键">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(50)" remarks="名称">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="ENABLED" remarks="状态"/>
            <column name="sort_order" type="INT" defaultValue="99" remarks="排序号"/>
            <column name="create_time" defaultValueComputed="CURRENT_TIMESTAMP" type="DATETIME" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" remarks="更新时间"
                    defaultValueComputed="CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP"/>
            <column name="version" type="BIGINT" defaultValue="0" remarks="版本"/>
        </createTable>

        <!-- 创建索引 -->
        <createIndex tableName="newmodule_entity" indexName="idx_newmodule_entity_name">
            <column name="name"/>
        </createIndex>

        <createIndex tableName="newmodule_entity" indexName="idx_newmodule_entity_status">
            <column name="status"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
```

#### 4.2.3 更新主变更文件
**文件位置**: `adapter/src/main/resources/db/changelog/master.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- 包含各模块的变更文件 -->
    <include file="classpath:db/changelog/v1.0/manager_department.xml"/>
    <include file="classpath:db/changelog/v1.0/manager_menu.xml"/>
    <include file="classpath:db/changelog/v1.0/newmodule_table.xml"/>
</databaseChangeLog>
```

### 4.3 JOOQ 配置

#### 4.3.1 创建 JOOQ 配置文件
**文件位置**: `src/main/resources/plugin/config/jooq-config.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <generator>
        <database>
            <!-- 生成表的过滤 -->
            <includes>newmodule_.*</includes>
        </database>
        <target>
            <!-- 生成的代码包名 -->
            <packageName>vip.geekclub.newmodule.query.dsl</packageName>
        </target>
    </generator>
</configuration>
```

#### 4.3.2 配置 Maven 插件
在模块的 `pom.xml` 中添加 JOOQ 插件配置：

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.jooq</groupId>
            <artifactId>jooq-codegen-maven</artifactId>
            <version>${jooq.version}</version>
            <executions>
                <execution>
                    <id>jooq-codegen</id>
                    <phase>generate-sources</phase>
                    <goals>
                        <goal>generate</goal>
                    </goals>
                    <configuration>
                        <configurationFile>src/main/resources/plugin/config/jooq-config.xml</configurationFile>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

### 4.4 模块集成

#### 4.4.1 在父POM中添加模块
**文件位置**: 根目录 `pom.xml`

```xml
<modules>
    <module>common</module>
    <module>security</module>
    <module>manager</module>
    <module>student</module>
    <module>new-module</module>
    <module>adapter</module>
</modules>
```

#### 4.4.2 在适配器模块中添加依赖
**文件位置**: `adapter/pom.xml`

```xml
<dependencies>
    <!-- 其他依赖 -->
    <dependency>
        <groupId>vip.geekclub</groupId>
        <artifactId>new-module</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
</dependencies>
```

### 4.5 代码生成

#### 4.5.1 生成数据库表
```bash
# 在项目根目录执行
mvn liquibase:update
```

#### 4.5.2 生成 JOOQ 代码
```bash
# 在项目根目录执行
mvn clean compile
```

### 4.6 验证配置

#### 4.6.1 检查数据库表
```sql
-- 检查表是否创建成功
SHOW TABLES LIKE 'newmodule_%';
```

#### 4.6.2 检查生成的代码
检查 `target/generated-sources/jooq` 目录下是否生成了对应的 JOOQ 类。

### 4.7 实际示例：创建课程模块

#### 4.7.1 创建课程模块目录结构
```
course/
├── pom.xml
└── src/
    ├── main/
    │   ├── java/vip/geekclub/course/
    │   │   ├── command/
    │   │   │   ├── dto/
    │   │   │   │   ├── CreateCourseCommand.java
    │   │   │   │   ├── UpdateCourseCommand.java
    │   │   │   │   └── DeleteCourseCommand.java
    │   │   └── handlers/
    │   │       ├── CreateCourseCommandHandler.java
    │   │       ├── UpdateCourseCommandHandler.java
    │   │       └── DeleteCourseCommandHandler.java
    │   │   ├── query/
    │   │   │   ├── dto/
    │   │   │   │   ├── CourseInfoResult.java
    │   │   │   │   └── CourseListResult.java
    │   │   │   └── CourseQueryService.java
    │   │   ├── domain/
    │   │   │   ├── model/
    │   │   │   │   └── Course.java
    │   │   │   ├── repository/
    │   │   │   │   └── CourseRepository.java
    │   │   │   ├── service/
    │   │   │   │   └── CourseDomainService.java
    │   │   │   └── values/
    │   │   │       ├── CourseCode.java
    │   │   │       ├── CourseName.java
    │   │   │       └── CourseStatus.java
    │   │   └── common/
    │   │       └── CourseStatus.java
    │   └── resources/
    │       ├── db/
    │       │   └── changelog/
    │       │       └── v1.0/
    │       │           └── course_course.xml
    │       └── plugin/
    │           └── config/
    │               ├── liquibase-config.xml
    │               └── jooq-config.xml
    └── test/
        └── java/vip/geekclub/course/
```

#### 4.7.2 创建课程模块POM文件
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>vip.geekclub</groupId>
        <artifactId>service</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>

    <artifactId>course</artifactId>

    <properties>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>vip.geekclub</groupId>
            <artifactId>common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.jooq</groupId>
            <artifactId>jooq</artifactId>
        </dependency>
    </dependencies>
</project>
```

#### 4.7.3 创建课程数据库表
**文件位置**: `course/src/main/resources/db/changelog/v1.0/course_course.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
    
    <!-- 创建课程表 -->
    <changeSet id="1750312342960-1" author="developer">
        <createTable tableName="course_course">
            <column name="id" type="BIGINT" autoIncrement="true" remarks="主键">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="course_code" type="VARCHAR(20)" remarks="课程代码">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="course_name" type="VARCHAR(100)" remarks="课程名称">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT" remarks="课程描述"/>
            <column name="credits" type="INT" defaultValue="0" remarks="学分"/>
            <column name="status" type="VARCHAR(20)" defaultValue="ACTIVE" remarks="状态"/>
            <column name="create_time" defaultValueComputed="CURRENT_TIMESTAMP" type="DATETIME" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" remarks="更新时间"
                    defaultValueComputed="CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP"/>
            <column name="version" type="BIGINT" defaultValue="0" remarks="版本"/>
        </createTable>

        <!-- 创建索引 -->
        <createIndex tableName="course_course" indexName="idx_course_course_code">
            <column name="course_code"/>
        </createIndex>

        <createIndex tableName="course_course" indexName="idx_course_course_name">
            <column name="course_name"/>
        </createIndex>

        <createIndex tableName="course_course" indexName="idx_course_status">
            <column name="status"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
```

#### 4.7.4 创建JOOQ配置
**文件位置**: `course/src/main/resources/plugin/config/jooq-config.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <generator>
        <database>
            <!-- 生成表的过滤 -->
            <includes>course_.*</includes>
        </database>
        <target>
            <!-- 生成的代码包名 -->
            <packageName>vip.geekclub.course.query.dsl</packageName>
        </target>
    </generator>
</configuration>
```

#### 4.7.5 创建Liquibase配置
**文件位置**: `course/src/main/resources/plugin/config/liquibase-config.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- 使用当前目录的相对路径 -->
    <includeAll path="db/changelog" minDepth="2" />
</databaseChangeLog>
```

### 4.8 常见问题解决

#### 4.8.1 Liquibase相关问题
**Q: 数据库表没有创建成功？**
A: 检查以下几点：
1. 确认 `master.xml` 中包含了新模块的变更文件
2. 检查数据库连接配置是否正确
3. 确认 Liquibase 插件配置正确

**Q: 如何回滚数据库变更？**
A: 使用以下命令：
```bash
mvn liquibase:rollback -Dliquibase.rollbackCount=1
```

#### 4.8.2 JOOQ相关问题
**Q: JOOQ代码没有生成？**
A: 检查以下几点：
1. 确认表名过滤规则正确
2. 确认数据库表已创建
3. 检查JOOQ插件配置

**Q: 如何重新生成JOOQ代码？**
A: 使用以下命令：
```bash
mvn clean compile
```

#### 4.8.3 模块集成问题
**Q: 新模块无法被识别？**
A: 检查以下几点：
1. 确认在父POM中添加了模块
2. 确认在adapter模块中添加了依赖
3. 执行 `mvn clean install` 重新构建

### 4.9 最佳实践

#### 4.9.1 命名规范
- 模块名使用小写，如 `course`、`student`
- 表名使用 `{模块名}_{实体名}` 格式，如 `course_course`
- 包名使用 `vip.geekclub.{模块名}` 格式

#### 4.9.2 文件组织
- 每个模块的数据库变更文件放在 `db/changelog/v1.0/` 目录下
- 配置文件放在 `plugin/config/` 目录下
- 遵循DDD分层架构组织Java代码

#### 4.9.3 版本管理
- 使用有意义的changeSet ID，如时间戳+序号
- 在changeSet中添加author信息
- 为每个changeSet添加详细的注释

### 4.10 自动化脚本

#### 4.10.1 创建模块脚本
可以创建一个Maven插件或脚本来自动化模块创建过程：

```bash
#!/bin/bash
# create-module.sh

MODULE_NAME=$1
if [ -z "$MODULE_NAME" ]; then
    echo "Usage: ./create-module.sh <module-name>"
    exit 1
fi

# 创建目录结构
mkdir -p $MODULE_NAME/src/main/java/vip/geekclub/$MODULE_NAME/{command/{dto,handlers},query/dto,domain/{model,repository,service,values},common}
mkdir -p $MODULE_NAME/src/main/resources/{db/changelog/v1.0,plugin/config}
mkdir -p $MODULE_NAME/src/test/java/vip/geekclub/$MODULE_NAME

# 创建POM文件
# ... 生成POM文件内容

# 创建配置文件
# ... 生成配置文件内容

echo "Module $MODULE_NAME created successfully!"
```

#### 4.10.2 验证脚本
```bash
#!/bin/bash
# validate-module.sh

MODULE_NAME=$1
if [ -z "$MODULE_NAME" ]; then
    echo "Usage: ./validate-module.sh <module-name>"
    exit 1
fi

echo "Validating module: $MODULE_NAME"

# 检查目录结构
if [ ! -d "$MODULE_NAME" ]; then
    echo "ERROR: Module directory not found"
    exit 1
fi

# 检查必要文件
if [ ! -f "$MODULE_NAME/pom.xml" ]; then
    echo "ERROR: pom.xml not found"
    exit 1
fi

# 检查数据库变更文件
if [ ! -f "$MODULE_NAME/src/main/resources/db/changelog/v1.0/${MODULE_NAME}_*.xml" ]; then
    echo "ERROR: Database changelog file not found"
    exit 1
fi

echo "Module validation passed!"
```
